# Story 1.6: Debug Overlay

Status: done

## Story

As a developer,
I want a debug overlay (F1 toggle) showing trend direction, scheduled events, price tick probabilities, and win rate tracking,
so that I can tune balance during development.

## Acceptance Criteria

1. F1 key toggles the debug overlay on/off
2. Overlay shows the underlying trend direction (Bull/Bear/Neutral) for each active stock
3. Overlay shows trend strength (trendPerSecond value) per stock
4. Overlay shows current noise amplitude and reversion speed per stock
5. Overlay shows active events and their remaining duration on affected stocks
6. Overlay is wrapped in `#if UNITY_EDITOR || DEVELOPMENT_BUILD` — excluded from release builds
7. Overlay does not interfere with gameplay input or UI interaction

## Tasks / Subtasks

- [x] Task 1: Create DebugManager MonoBehaviour (AC: 1, 6)
  - [x] Entire class wrapped in `#if UNITY_EDITOR || DEVELOPMENT_BUILD`
  - [x] F1 key toggles overlay visibility
  - [x] Static `IsOverlayVisible` property exposed
  - [x] File: `Scripts/Editor/DebugManager.cs`
- [x] Task 2: Create DebugOverlayUI for price engine data (AC: 2, 3, 4, 5, 7)
  - [x] Semi-transparent panel in top-right corner (320px wide)
  - [x] Per-stock: Ticker, arrow+direction, price, TrendPerSecond, NoiseAmplitude, ReversionSpeed, TrendLinePrice
  - [x] Active event name + remaining seconds displayed in orange
  - [x] Uses OnGUI() with styled GUIStyles — debug tool, not polished UI
  - [x] Positioned to not block chart area (right side)
  - [x] Combined into DebugManager.cs (no separate file needed)
- [x] Task 3: Expose PriceEngine debug data (AC: 2, 3, 4, 5)
  - [x] `StockDebugInfo` struct with all debug fields
  - [x] `GetDebugInfo()` method returns list of per-stock snapshots
  - [x] Includes active event type and time remaining
  - [x] File: `Scripts/Runtime/PriceEngine/PriceGenerator.cs` (extended)
- [x] Task 4: Add DebugManager to Setup pipeline (AC: 1)
  - [x] DebugSetup.Execute() creates DebugManager GameObject
  - [x] Wrapped in conditional compilation
  - [x] SetupClass attribute commented out pending SetupPipeline infrastructure
  - [x] File: `Scripts/Setup/DebugSetup.cs` (new)
- [x] Task 5: Reserve F2-F4 key slots (AC: 6)
  - [x] F2: God mode placeholder (logs "not yet implemented")
  - [x] F3: Skip to round placeholder
  - [x] F4: Event trigger placeholder

## Dev Notes

### Architecture Compliance

- **Location:** Debug tools in `Scripts/Editor/` per architecture doc
- **Debug key mapping:** F1=overlay, F2=god mode, F3=skip round, F4=event trigger (per architecture Debug Tools table)
- **Conditional compilation:** ALL debug code wrapped in `#if UNITY_EDITOR || DEVELOPMENT_BUILD`
- **Setup Framework:** DebugManager is generated by a setup class, not manually placed in scene
- **Read-only access:** DebugOverlay reads from PriceEngine — never writes to it

### Architecture Debug Tools Reference

| Tool | Key | Purpose |
|------|-----|---------|
| Debug overlay | F1 | Price trends, scheduled events, win rate, economy stats |
| God mode | F2 | Infinite cash, can't fail margin call |
| Skip to round | F3 | Jump to any act/round with configurable starting cash |
| Event trigger | F4 | Force-fire any event type on any stock |

This story implements F1 only. F2-F4 are future stories (Epic 4 and Epic 5 will use them).

### Implementation Guidance

For the overlay display, `OnGUI` with `GUILayout` is the fastest approach for debug tools — no need for uGUI Canvas elements. Keep it simple:

```csharp
#if UNITY_EDITOR || DEVELOPMENT_BUILD
void OnGUI()
{
    if (!_isVisible) return;

    GUILayout.BeginArea(new Rect(Screen.width - 320, 10, 310, Screen.height - 20));
    GUILayout.Label("=== PRICE ENGINE DEBUG ===", _headerStyle);

    foreach (var stock in _priceGenerator.GetDebugInfo())
    {
        GUILayout.Label($"{stock.Ticker} | {stock.TrendDirection} | Trend: {stock.TrendPerSecond:F3}/s");
        GUILayout.Label($"  Noise: {stock.NoiseAmplitude:F3} | Reversion: {stock.ReversionSpeed:F3}");
        if (stock.HasActiveEvent)
            GUILayout.Label($"  EVENT: {stock.ActiveEventType} ({stock.EventTimeRemaining:F1}s)");
    }

    GUILayout.EndArea();
}
#endif
```

### Note on Win Rate Tracking

The GDD mentions win rate tracking in the debug overlay, but this requires meta-progression and run tracking (Epic 9). For now, implement the Price Engine portion. Win rate display will be added when the meta system exists.

### Project Structure Notes

- Creates: `Scripts/Editor/DebugManager.cs`
- Creates: `Scripts/Editor/DebugOverlayUI.cs` (or combined into DebugManager)
- Creates: `Scripts/Setup/DebugSetup.cs`
- Modifies: `Scripts/Runtime/PriceEngine/PriceGenerator.cs` (add GetDebugInfo method)

### References

- [Source: game-architecture.md#Debug Tools] — F1-F4 key mapping and purpose table
- [Source: game-architecture.md#Debug Tools] — "All wrapped in #if UNITY_EDITOR || DEVELOPMENT_BUILD"
- [Source: game-architecture.md#Debug Tools] — "Single DebugManager MonoBehaviour generated by setup code"
- [Source: game-architecture.md#Consistency Rules] — "New debug tool: Add to DebugManager.cs, #if conditional"
- [Source: bull-run-gdd-mvp.md#11.3] — "Implement a debug overlay (toggled with F1) that shows: the underlying trend direction..."

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6

### Debug Log References
- `[Debug] Overlay ON/OFF` on F1 toggle
- `[Debug] God mode not yet implemented` on F2
- `[Debug] Skip to round not yet implemented` on F3
- `[Debug] Event trigger not yet implemented` on F4
- `[Setup] DebugManager created` during setup

### Completion Notes List
- DebugManager handles F1-F4, with overlay rendering via OnGUI
- StockDebugInfo struct added to PriceGenerator.cs for clean data access
- DebugSetup created with SetupClass attribute commented out (awaiting pipeline infrastructure)
- Overlay shows: ticker, price, trend direction/arrow, trend per second, trend line price, noise amplitude, reversion speed, active events with remaining time
- 5 new tests for GetDebugInfo on PriceGenerator

### File List
- `Assets/Scripts/Editor/DebugManager.cs` — NEW: F1 overlay toggle, F2-F4 placeholders, OnGUI rendering
- `Assets/Scripts/Setup/DebugSetup.cs` — NEW: creates DebugManager GameObject
- `Assets/Scripts/Runtime/PriceEngine/PriceGenerator.cs` — added StockDebugInfo struct + GetDebugInfo()
- `Assets/Tests/Runtime/PriceEngine/PriceGeneratorTests.cs` — 5 new debug info tests
