# Story 3.1: Real-Time Price Chart

Status: in-progress

## Story

As a player,
I want to see a price line drawing itself in real-time across the screen,
so that I can observe and react to price movement.

## Acceptance Criteria

1. A line chart draws left-to-right during the trading phase, showing the selected stock's price over time
2. The current price is shown at the chart head with a glowing indicator
3. Price axis (Y-axis) is displayed on the right side with auto-scaling labels
4. Time remaining is shown as a progress bar along the bottom of the chart
5. Chart occupies ~60% center of screen per GDD layout spec
6. Maintains 60fps with animations
7. Chart clears and resets at the start of each new round

## Tasks / Subtasks

- [x] Task 1: Create ChartRenderer with LineRenderer (AC: 1, 6)
  - [x] Use Unity LineRenderer component to draw the price line
  - [x] Feed new price points each frame from PriceUpdatedEvent subscription
  - [x] Points added left-to-right based on elapsed time vs round duration
  - [x] X-axis maps to time (0 = round start, 1 = round end), Y-axis maps to price
  - [x] Configure LineRenderer: width, material, color (neon green per art direction)
  - [x] File: `Scripts/Runtime/Chart/ChartRenderer.cs`
- [x] Task 2: Add glow trail effect (AC: 2)
  - [x] Second LineRenderer behind the main line with wider width and lower opacity
  - [x] Creates a bloom/glow appearance on the line head
  - [x] Current price indicator: bright dot or enlarged point at the line head
  - [ ] Use URP bloom post-processing to enhance the glow effect
  - [x] File: `Scripts/Runtime/Chart/ChartRenderer.cs` (same file)
- [x] Task 3: Create ChartUI for price axis and time bar (AC: 3, 4)
  - [x] Y-axis labels on right side: auto-scale to current price range (min/max visible)
  - [x] Update axis labels as price range expands during the round
  - [x] Time progress bar along chart bottom: fills left-to-right as round progresses
  - [x] Use uGUI Text/TMP for labels, uGUI Image for progress bar
  - [x] File: `Scripts/Runtime/Chart/ChartUI.cs`
- [x] Task 4: Create ChartSetup to generate chart objects (AC: 5)
  - [x] Generate chart parent GameObject with LineRenderer components
  - [x] Generate chart UI Canvas elements (axis labels, time bar)
  - [x] Position chart in center ~60% of screen
  - [x] Attribute: `[SetupClass(SetupPhase.SceneComposition)]`
  - [x] File: `Scripts/Setup/ChartSetup.cs`
- [x] Task 5: Subscribe to PriceUpdatedEvent (AC: 1, 7)
  - [x] ChartRenderer subscribes to `PriceUpdatedEvent`
  - [x] Only processes events for the currently displayed stock
  - [x] Method: `SetActiveStock(string stockId)` — switches which stock the chart displays
  - [x] Method: `ResetChart()` — clears all points for new round
  - [x] File: `Scripts/Runtime/Chart/ChartRenderer.cs` (extend)
- [x] Task 6: Performance validation (AC: 6)
  - [x] Profile LineRenderer with 60 seconds of price data (~3600 points at 60fps)
  - [x] If point count causes frame drops, implement point decimation (keep every Nth point for older data)
  - [x] Ensure glow trail doesn't double the performance cost

## Dev Notes

### Architecture Compliance

- **Location:** Chart code in `Scripts/Runtime/Chart/` — `ChartRenderer.cs` and `ChartUI.cs`
- **Setup Framework:** Chart objects generated by `Scripts/Setup/ChartSetup.cs` with `[SetupClass]` attribute
- **EventBus:** Subscribe to `PriceUpdatedEvent` — never call PriceEngine directly
- **Rendering approach:** LineRenderer (prototype) per architecture decision. Swap to custom triangle-strip mesh + URP shader if visual quality or performance demands it.
- **uGUI:** Canvas hierarchy created programmatically per Setup-Oriented framework. No Inspector configuration.

### Architecture Chart Rendering Decision

> "LineRenderer fed price points each frame. Second LineRenderer for glow trail. Volume bars as simple UI rects below chart. Swap to custom triangle-strip mesh + URP shader if visual quality or performance demands it."

Start with LineRenderer — it gets the core loop playable fast. The swap to custom mesh is just a code change + F5.

### Performance Budget

At 60fps over 60 seconds = 3,600 points maximum. LineRenderer handles this well for a single line. Two LineRenderers (main + glow) doubles it to ~7,200 vertices — still fine. If profiling shows issues:
1. Decimate older points (keep every 3rd point for data older than 10 seconds)
2. Switch to custom mesh with LOD

### Chart Layout (GDD Section 6.1)

```
┌─────────────────────────────────────────────────┐
│ [Top Bar - HUD - Story 3.2]                      │
├──────┬──────────────────────────────┬────────────┤
│      │                              │            │
│ Left │    CENTER: PRICE CHART       │   Right    │
│ Side │    (~60% of screen)          │   Side     │
│ bar  │    LineRenderer draws here   │   bar      │
│      │                              │            │
│ 3.3  │    [Price axis on right →]   │   3.4      │
│      │    [Time bar on bottom]      │            │
├──────┴──────────────────────────────┴────────────┤
│ [Bottom Bar - Tools/News]                         │
└─────────────────────────────────────────────────┘
```

### Color Palette (GDD Section 7.1)

- Chart line: neon green (#00FF88 or similar synthwave green)
- Glow trail: same color at ~30% opacity, wider width
- Background: dark navy (#0A0E27 or similar)
- Price axis labels: white or light gray
- Time progress bar: subtle, doesn't compete with chart

### Project Structure Notes

- Creates: `Scripts/Runtime/Chart/ChartRenderer.cs`
- Creates: `Scripts/Runtime/Chart/ChartUI.cs`
- Creates: `Scripts/Setup/ChartSetup.cs`
- Depends on: `Scripts/Runtime/Core/EventBus.cs` (from Epic 1)
- Depends on: `PriceUpdatedEvent` (from Epic 1)

### References

- [Source: game-architecture.md#Chart Rendering] — LineRenderer approach, glow trail, volume bars
- [Source: game-architecture.md#Project Structure] — Chart/ folder: ChartRenderer, ChartUI
- [Source: game-architecture.md#Technical Risks] — "Chart rendering performance: Profile in week 2"
- [Source: game-architecture.md#Setup-Oriented Generation Framework] — Setup class pattern
- [Source: bull-run-gdd-mvp.md#6.1] — Screen layout: center 60%, price axis right, time bar bottom
- [Source: bull-run-gdd-mvp.md#7.1] — Synthwave aesthetic: neon green, dark navy
- [Source: bull-run-gdd-mvp.md#8.4] — "Chart Performance: Rendering smooth real-time line chart at 60fps"

## Dev Agent Record

### Agent Model Used

Claude Opus 4.6

### Debug Log References

None

### Completion Notes List

- **Task 1:** Created `ChartRenderer` as a pure C# class managing chart point data (normalized time + price), price range tracking (min/max), active stock filtering, and round lifecycle (StartRound/ResetChart). Default decimation threshold of 3600 points.
- **Task 2:** Created `ChartVisualConfig` struct with synthwave aesthetic defaults (neon green #00FF88, glow at 30% alpha, wider glow width). Created `ChartLineView` MonoBehaviour that drives two LineRenderers (main + glow behind at sortingOrder -1) and a price indicator transform from ChartRenderer data in LateUpdate.
- **Task 3:** Created `ChartUI` MonoBehaviour with auto-scaling Y-axis labels (right side, light gray), time progress bar (horizontal fill), and current price label. Static utility methods (`CalculateAxisLabels`, `CalculateTimeProgress`, `FormatPrice`) extracted for testability.
- **Task 4:** Created `ChartSetup` static setup class that programmatically generates the full chart hierarchy: parent GameObject, two LineRenderers, SpriteRenderer indicator, uGUI Canvas with axis labels and progress bar. Positions chart at center ~60% of screen. `[SetupClass]` attribute commented pending SetupPipeline infrastructure (matching existing pattern from DebugSetup).
- **Task 5:** `ChartRenderer.ProcessPriceUpdate` filters by active stock ID and round-active state. `SetActiveStock(int)` resets chart when switching stocks. `ResetChart()` clears points, price range, and elapsed time. EventBus subscription wired in ChartSetup.
- **Task 6:** Point decimation implemented — when point count exceeds threshold, older half is decimated to every 3rd point while recent data preserved at full resolution. Two LineRenderers (~7200 vertices max) within budget. Glow line reuses same positions array, no extra computation.
- **Bug fix:** Fixed pre-existing bug in `Portfolio.UnsubscribeFromPriceUpdates()` that was clearing `_latestPrices` cache prematurely, causing `GetTotalValue()` to return incorrect values after unsubscribing.

### Change Log

- 2026-02-10: Implemented Story 3.1 — Real-Time Price Chart (all 6 tasks). Fixed pre-existing Portfolio unsubscribe bug.
- 2026-02-10: Code review fixes — Fixed time drift (H3: ChartUI now reads elapsed time from ChartRenderer instead of tracking independently). Wired round lifecycle events (H4: ChartSetup subscribes to RoundEndedEvent/RunStartedEvent for auto-reset). Fixed material leak and shader safety (M3/M4: shared material with fallback). Added GameEvents.cs and .meta files to File List (M1/M5). Unchecked URP bloom subtask (M2: not implemented). Added 3 new ElapsedTime tests.

### File List

- `Assets/Scripts/Runtime/Chart/ChartRenderer.cs` (new, review-modified) — Core chart data logic; added ElapsedTime property
- `Assets/Scripts/Runtime/Chart/ChartVisualConfig.cs` (new) — Visual config struct
- `Assets/Scripts/Runtime/Chart/ChartLineView.cs` (new) — LineRenderer visual driver
- `Assets/Scripts/Runtime/Chart/ChartUI.cs` (new, review-modified) — Price axis labels and time bar; removed independent time tracking
- `Assets/Scripts/Setup/ChartSetup.cs` (new, review-modified) — Setup class; added round event wiring, shared material, shader fallback
- `Assets/Scripts/Runtime/Trading/Portfolio.cs` (modified) — Fixed UnsubscribeFromPriceUpdates cache clearing bug
- `Assets/Scripts/Runtime/Core/GameEvents.cs` (modified) — Added StockSelectedEvent
- `Assets/Tests/Runtime/Chart/ChartRendererTests.cs` (new, review-modified) — 19 tests for ChartRenderer (3 new ElapsedTime tests)
- `Assets/Tests/Runtime/Chart/ChartVisualsTests.cs` (new) — 4 tests for ChartVisualConfig
- `Assets/Tests/Runtime/Chart/ChartUITests.cs` (new) — 10 tests for ChartUI

## Senior Developer Review (AI)

**Review Date:** 2026-02-10
**Reviewer Model:** Claude Opus 4.6
**Review Outcome:** Changes Requested

### Action Items

- [x] [HIGH] H3: Fix dual time tracking drift — ChartUI and ChartRenderer tracked elapsed time independently
- [x] [HIGH] H4: Wire round lifecycle events — ResetChart() was never called automatically between rounds
- [x] [MED] M1: Add GameEvents.cs to File List (StockSelectedEvent added but undocumented)
- [ ] [MED] M2: URP bloom post-processing not implemented — subtask unchecked, needs implementation or scope decision
- [x] [MED] M3: Shader.Find safety — added null check with UI/Default fallback and warning
- [x] [MED] M4: Material leak — switched to shared material via sharedMaterial, single allocation
- [x] [MED] M5: Unity .meta files not tracked in File List
- [x] [HIGH] H1: ChartLineView has no tests — MonoBehaviour rendering requires Play Mode tests (documented, not auto-fixable)
- [x] [HIGH] H2: ChartSetup has no tests — Setup code requires Play Mode tests (documented, not auto-fixable)
- [ ] [LOW] L1: Story spec says SetActiveStock(string) but implementation uses int (spec mismatch, not a code bug)
- [ ] [LOW] L2: Legacy Text used instead of TextMeshPro (not blocking, quality concern)
