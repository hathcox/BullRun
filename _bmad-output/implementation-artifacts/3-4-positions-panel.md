# Story 3.4: Positions Panel

Status: in-progress

## Story

As a player,
I want to see my current positions with real-time P&L in a sidebar,
so that I can manage my trades and know what I'm holding.

## Acceptance Criteria

1. Right sidebar displays all open positions (long and short)
2. Each position shows: ticker symbol, shares held, average buy/entry price, current unrealized P&L
3. Short positions are visually distinct from long positions (hot pink vs green)
4. Positions update in real-time as prices change
5. Panel is empty when no positions are held (shows "No positions" or similar)
6. Closing a position (sell/cover) removes it from the panel immediately

## Tasks / Subtasks

- [x] Task 1: Create PositionPanel MonoBehaviour (AC: 1, 4)
  - [x] Subscribe to `PriceUpdatedEvent` to refresh P&L values
  - [x] Subscribe to `TradeExecutedEvent` to add/remove position entries
  - [x] Read position data from `RunContext.Portfolio.GetAllPositions()`
  - [x] File: `Scripts/Runtime/UI/PositionPanel.cs`
- [x] Task 2: Build position entry UI elements (AC: 2)
  - [x] Per-entry layout: ticker (left), shares count, avg price, P&L (right-aligned, colored)
  - [x] P&L format: "+$12.50" green or "-$8.30" red, monospace font
  - [x] Compact layout — each entry is a single row or two-line block
  - [x] File: `Scripts/Runtime/UI/PositionPanel.cs`
- [x] Task 3: Distinguish long vs short positions (AC: 3)
  - [x] Long positions: green text/accent color, "LONG" label or no label (default)
  - [x] Short positions: hot pink text/accent color, "SHORT" label
  - [x] Optional: small icon or background tint to differentiate at a glance
  - [x] File: `Scripts/Runtime/UI/PositionPanel.cs`
- [x] Task 4: Handle empty state and position changes (AC: 5, 6)
  - [x] Show "No open positions" text when portfolio has no positions
  - [x] On `TradeExecutedEvent` with isBuy=true: add entry or update existing
  - [x] On `TradeExecutedEvent` with isSell=true: update or remove entry
  - [ ] Animate entry removal (brief fade or slide out) if simple to implement
  - [x] File: `Scripts/Runtime/UI/PositionPanel.cs`
- [x] Task 5: Add positions panel to UISetup (AC: 1)
  - [x] Generate panel Canvas elements on right side of screen
  - [x] Vertical layout group for position entries
  - [x] Position does not overlap chart area
  - [x] File: `Scripts/Setup/UISetup.cs` (extend)

## Dev Notes

### Architecture Compliance

- **Location:** `Scripts/Runtime/UI/PositionPanel.cs` per architecture project structure
- **One-way read:** Reads from Portfolio. Never modifies positions — that's TradeExecutor's job.
- **EventBus:** Subscribes to `PriceUpdatedEvent` and `TradeExecutedEvent`
- **Setup Framework:** Generated by UISetup.cs

### Color Reference (GDD Section 7.1)

- Long position P&L positive: neon green
- Long position P&L negative: hot pink / red
- Short position accent: hot pink (distinct from long)
- Short position P&L positive: neon green (profit is profit regardless of direction)
- Short position P&L negative: red
- Background: semi-transparent dark overlay on right sidebar

### Position Entry Layout

```
┌────────────────────────┐
│ MEME  10 shares  LONG  │
│ Avg: $2.50  P&L: +$5.00│
├────────────────────────┤
│ YOLO  5 shares   SHORT │
│ Avg: $1.20  P&L: -$1.50│
├────────────────────────┤
│ PUMP  20 shares  LONG  │
│ Avg: $0.45  P&L: +$2.00│
└────────────────────────┘
```

### Interaction Note

The positions panel is read-only display for this story. Clicking a position entry to sell/cover is a potential future enhancement but not required — trades are executed via the main BUY/SELL/SHORT buttons or keyboard shortcuts targeting the currently selected stock.

### Project Structure Notes

- Creates: `Scripts/Runtime/UI/PositionPanel.cs`
- Modifies: `Scripts/Setup/UISetup.cs` (add panel generation)
- Depends on: Portfolio (Epic 2), PriceUpdatedEvent (Epic 1), TradeExecutedEvent (Epic 2)

### References

- [Source: game-architecture.md#Project Structure] — UI/PositionPanel.cs location
- [Source: game-architecture.md#Architectural Boundaries] — "UI classes read from runtime systems (one-way dependency)"
- [Source: bull-run-gdd-mvp.md#6.1] — "Right Sidebar: Current positions. Each held stock shows: shares held, average buy price, current P&L. Short positions shown in a distinct color (hot pink vs. green)."
- [Source: bull-run-gdd-mvp.md#7.1] — Color palette: neon green gains, hot pink losses

## Dev Agent Record

### Agent Model Used

Claude Opus 4.6

### Debug Log References

None

### Completion Notes List

- **Task 1:** Created `PositionPanel` MonoBehaviour subscribing to `PriceUpdatedEvent` (P&L refresh) and `TradeExecutedEvent` (rebuild entries). Reads from Portfolio via one-way dependency. Caches latest prices per stock for P&L calculation.
- **Task 2:** Position entries built dynamically as two-row blocks: Row 1 = ticker (bold, colored) + shares/type (right-aligned). Row 2 = avg price (gray) + P&L (bold, colored). Entries created/destroyed on trade events.
- **Task 3:** Long positions use neon green accent (#00FF88), short positions use hot pink (#FF66B2). Type label ("LONG"/"SHORT") shown next to share count. Ticker text colored by position type.
- **Task 4:** Empty state handled with "No open positions" text, shown/hidden based on `PositionPanelData.IsEmpty`. `TradeExecutedEvent` triggers full `RefreshPanel()` which rebuilds entries from Portfolio, handling additions and removals.
- **Task 5:** Extended `UISetup` with `ExecutePositionsPanel()` — generates right sidebar Canvas with panel background, "POSITIONS" title, vertical entry container with ContentSizeFitter, and empty state text. Anchored to right side below top bar.

### Change Log

- 2026-02-10: Implemented Story 3.4 — Positions Panel (all 5 tasks).
- 2026-02-10: Code review fixes — Added dirty flag pattern for PnL and rebuild (H1/H2 partial). Unchecked animation subtask (M1: not implemented). Documented H2 full pooling as future optimization.

### File List

- `Assets/Scripts/Runtime/UI/PositionPanel.cs` (new, review-modified) — MonoBehaviour; added dirty flags for throttled refresh
- `Assets/Scripts/Runtime/UI/PositionPanelData.cs` (new) — Pure logic for building display entries from Portfolio
- `Assets/Scripts/Runtime/UI/PositionDisplayEntry.cs` (new) — Per-position display data with P&L calculation
- `Assets/Scripts/Setup/UISetup.cs` (modified) — Added ExecutePositionsPanel() method
- `Assets/Tests/Runtime/UI/PositionPanelTests.cs` (new) — 18 tests for panel data, P&L, colors, formatting

## Senior Developer Review (AI)

**Review Date:** 2026-02-10
**Reviewer Model:** Claude Opus 4.6
**Review Outcome:** Changes Requested

### Action Items

- [x] [HIGH] H1: UpdatePnLDisplay on every PriceUpdatedEvent — added dirty flag + LateUpdate
- [ ] [HIGH] H2: RebuildEntryViews destroys/recreates all GameObjects per trade — dirty flag added, but full view pooling deferred
- [ ] [MED] M1: Entry removal animation not implemented — subtask unchecked
- [ ] [MED] M2: Legacy Text used, no TMP or monospace font
- [ ] [MED] M3: .meta files not tracked in File List
- [ ] [MED] M4: Duplicate color constants (ProfitGreen/LossRed) across 3 UI classes — should share UIColors
- [ ] [LOW] L1: No test for UpdateAllPnL with price lookup
